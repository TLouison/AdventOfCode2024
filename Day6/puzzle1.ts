const inputMap: string = `................#......#...........#...........................#......#...........#........................................#......
  .......................................................................................#........#............#.............#.....#
  #.......................#...#..........#...........#........#.......................#............#................................
  .............#...............................................#........#................................#....#......#..............
  ...#..................................#......................#....#....................................#.................#........
  ...................#.....#......#...........#............................#......................#.#........................#......
  ...........................#..#...........#.............................#.........#.##.............#..............................
  .#.................#................#..........##.........##..............#...................................................#...
  ...............................#......................#........#.......................#.........#...........#....................
  ...................................#................#.............................................................................
  ..#...............##.......#................#.#......#...........#................................................................
  ....#.#.....#..............#........##........................##...........................................#...............#......
  .....................#..........#.................................#.....................................#.........................
  ..............#.........................................##......#.......................#..............#.................#..#.....
  ...........#...#..........................................................#.......#.............................#................#
  ................................#.#...............#...............................#..............##...............................
  .........................................................#............#......................................#.................#..
  ......#.#....#.................................#....###..................#......#.........#....#..................................
  ..............#...................................#..........#............#.......#...............................................
  ..............#......#...............#.............................................#.............................................#
  ....#.#..............#................#......................................................................#....................
  ........................................................#...........#..#.#.....................#....#.....#........#...#.......#..
  ..............#.......#................#............................#..#.......#.........#...........#...#...#....#....#.....#....
  ...#...............................................................................................#..#..#..........#.............
  .......#.........#..###..................................##...............##..#.......................#..........#...........#...#
  .......#.....................#.............#...........#...............................................#.................#........
  ..........#............................#..............................#......#..#.........#...............................#.......
  .............................#...............#............#..............................................................#........
  ...........#...................#......#......................#.......................#...............#......#.....................
  ..#..............................................#.........................#.............#...#.#..................................
  ................#.............................#....................................#.....#...................#..#.....#...........
  #............................#...#........................#................#....#.............................................#...
  ...............#.............#........#...................................................................#.......#....#..#.......
  ...........#......#.....#........................#.#..........................................#............#......................
  .#.....................................................#...............#.........................#................#...........#...
  .........................................#.............#......#.#....................................................#.........#..
  ................................#...#......................................................#..........................#..........#
  .#.........................#..............#.#.....................................................................................
  .........#..........#.............##.........#..#.................#........................#.....#.##....................#........
  ...................................................................................#...........................................#..
  ................#..........................................#...#...#.................................................#.........#..
  ..............................................#..............#..................#......#...#....#..#..............................
  ......#......#.................#.............#..................#...............#.............#..................#...............#
  .................................#.......#......#.......#.............................................................#........#..
  ..................#......#...................................#.................#.......#..........................................
  ....................#.........#.........................#..........#..........#..................#................................
  ..........#...........#...............#.#..................................................................................#......
  ..................#..#....................................................#..........#......#................................#....
  ............#.................................................................................................#........#..........
  .........#...............................................#.........##...........................#.................................
  ...#.........#........................................................#....................................#......................
  ........#......................#......#............#........#...............#.......................#.............................
  .......#..............................................................................................#....................#......
  .#.#..........#.......#.............##......................#..........................................................#..........
  ............#.#...........#............................................................#..........................................
  ............#..........................................................................#....................#...............#.....
  .......................#.....#...#........................................#.......#.........#.........................#...........
  ....................#..............#......#.......................................................................................
  ......................#....................................................................#...............#...#............#.....
  ........#..........#....................#...#........#......#..........................#....#..................#..#...............
  ................#...........................................................................................................#.....
  .#...............#..........................................................................................#......#..#.#.........
  ..............#................#...............#.........#.........#................................#.#...........................
  ...#................#..............#........................#...#.......................................#.#.......................
  #.........................................#..#....................................................................#...............
  .............#...........#.......#.#.....................................................................#.....#..................
  .............#..............................................................................#.....................................
  ........................#........#....#........#.#.............................................^..........#.......................
  ...............................#.......................................................#.............##.......#.......#...........
  #.#..............#..........................................#.......#..........................................#..................
  ...##...............................#........#.............##..................................................#..................
  ..#..#.................................................................#............#...#...#.....................................
  ....................#.#...#............#.......#.............#.......#..............#.............................................
  ..#..#.........#.............................................................................#......................#...#.........
  ....................................................#.........................#..#...#.#.#......#...............................#.
  ......#.....#.....................................................................#..............................................#
  ....................#........#..........................................................#.......#........................#........
  ................#.........................#...........................#...........................................#..............#
  ..#.......#..................................................#..................................#.................................
  ..........#.....................#...#.#...........#....................................#..........................................
  .....................................#...........................................................#..........#...................#.
  ....#............................#.........................................#.........................#............................
  ......#............#...........#......#.#..................................#......................................................
  ..................#.......#.....#......#.................................................................#................#.......
  ...........#.....#........................................................#.............#.........................................
  .................................#...........................#........#.........#............#.............................#.....#
  ..#........................#.................................#....................................................................
  ......................................................................................................#........#.#...#............
  #............................#..........#.#.....................#.............................................................#...
  .......#.......#................#..........#..........................#........#....#...#........................................#
  ....#.....#..........................................................#.........................#....................#..#.......#..
  .......#.............#.................................#...................................................................#......
  ...............#.......................................#.#...............................#.#..........#...........................
  ....#......#...#.#.........................#...............#...........#.......#........................................#..#......
  ...................#.........................................#.....................................................#..#.....#...#.
  ....#......#.#.............................#..........##........#......................#.#.......................#....#...........
  ........#.........................#........#.#..........................##..............#....#....................................
  .............#.....#..........#.....#.......#..##...#.....................#..................................#....................
  ....#....#...........................#...........#....................#.....#.......#....#.........#.....#....#...................
  ............#...#....................#..........#.......#......#............#.........................#............##.............
  .....................#.................................................................####.......................................
  ...#...........................................................................#......#..............#....#.......#...............
  ....#...#...#.....................#.............#..............................#...................#...........#..................
  ............................#...........#........#.............#..................................................................
  ...#.....#......#.....................#...........................................#...........#........#..........................
  .................#...........................#................................................................#..........#........
  .....................#........#...#...................................................................................#......#....
  .#...............................#...#....#.................#...#......#..........................................................
  ....................#..........#.........................................#....................#.........#.........................
  .......#.............#............#................#..........#.#.#.....................#............#.....................#......
  ......................#.........................#.................#...........................#................#..................
  ...#....#..........................#.#..##.................#..#..........#..............................................#.........
  ...........#.........................................................................................#.............#..............
  ..............#.................##...........#..#.............................................#..............................#....
  ...............................................##.......#..#.....#........#...#.............#.....................#...............
  ........#...................#...........#...............................#............................................#........#...
  ...................................#.....#......................#...#.........##..#...................#.#.........................
  ............#...........##............#.......................#.....#.......#...................#.................................
  ..#..#..............................#.......#.........#.....................................#.............#..#.................#..
  ..................#..................#..........................##..................#...#.......#.........#..................#....
  .........#.........#..............................................#...........................................................#...
  ......................#...........#..................................#............................#......#.....#..................
  .....#....#......#..................#.....#..............#.............................................#.....#....................
  ..............##...........#........................................................................#........#.#..................
  ..........#...............................##.......#............#.#.........#.....................................#....#..........
  .................................#..............#.............................#........................................#..........
  ....................#.................#..........#..............#.......................#...................................#.....
  ............#..............................#.............................#......#......#......................#...#...............
  .#..........#...............#..................................................................#....#.............................
  ....#............................................#......#..................#.....#............#.........................#.........`;

// const inputMap: string = `....#.....
// .........#
// ..........
// ..#.......
// .......#..
// ..........
// .#..^.....
// ........#.
// #.........
// ......#...`;

enum Direction {
  UP = 1,
  DOWN,
  LEFT,
  RIGHT,
}

class Coordinate {
  x: number;
  y: number;

  constructor(x: number, y: number) {
    this.x = x;
    this.y = y;
  }

  copy(): Coordinate {
    return new Coordinate(this.x, this.y);
  }

  getValue(map: string[][]): string {
    return map[this.y][this.x];
  }

  setValue(map: string[][], val: string) {
    map[this.y][this.x] = val;
  }
}

class ObstacleDetectedError extends Error {
  constructor(message: string) {
    super(message);
    this.name = "ObstacleDetectedError";
  }
}

function outputMap(map: string[]) {
  for (var line of map) {
    console.log(line.join(""));
  }
}

function loadMap(inputMap: string): string[][] {
  const lines = inputMap.trim().split("\n");
  let map: string[][] = [];
  for (var line of lines) {
    map.push(line.trim().split(""));
  }
  console.log("Got map", map);
  return map;
}

function findStart(map: string[][]): Coordinate {
  for (var y = 0; y < map.length; y++) {
    for (var x = 0; x < map[0].length; x++) {
      if (map[y][x] == "^") {
        return new Coordinate(x, y);
      }
    }
  }
  return new Coordinate(0, 0);
}

function newDirection(dir: Direction): Direction {
  switch (dir) {
    case Direction.UP:
      return Direction.RIGHT;
    case Direction.RIGHT:
      return Direction.DOWN;
    case Direction.DOWN:
      return Direction.LEFT;
    case Direction.LEFT:
      return Direction.UP;
  }
}

function getDirectionChar(dir: Direction): string {
  switch (dir) {
    case Direction.UP:
      return "^";
    case Direction.DOWN:
      return "V";
    case Direction.LEFT:
      return "<";
    case Direction.RIGHT:
      return ">";
  }
}

function move(pos: Coordinate, dir: Direction): Coordinate | Error {
  let newPos = pos.copy();

  switch (dir) {
    case Direction.UP: {
      newPos.y -= 1;
      break;
    }
    case Direction.DOWN: {
      newPos.y += 1;
      break;
    }
    case Direction.LEFT: {
      newPos.x -= 1;
      break;
    }
    case Direction.RIGHT: {
      newPos.x += 1;
      break;
    }
  }

  console.log(
    `Previous position was (${pos.x}, ${pos.y}). Next position will be (${newPos.x}, ${newPos.y})`,
  );
  // Check to see if the new value is an open square. If it is, return the new coord. If it is not,
  // whether because it is out of the grid or because there is an obstacle, return an error
  if (newPos.y < 0 || newPos.y >= maxH || newPos.x < 0 || newPos.x >= maxH) {
    return new RangeError("New position out of bounds");
  } else if (newPos.getValue(map) === "#") {
    return new ObstacleDetectedError("Obstacle in the way");
  } else {
    return newPos;
  }
}

function solve(map: string[][]): number {
  let visited = 1;

  let direction = Direction.UP;
  let position = findStart(map);

  // Starting from the start position, we are calling move() over and over. There are three conditions:
  // 1. We get a coordinate back. This means we can move and we should add 1 to visited and set the position to there.
  // 2. We get an error back. This means we cannot move and need to look at the error to determine why
  //     1. If it is because there is an obstacle, call nextDirection() and keep going
  //     2. If it is because we are off the grid, end iteration
  while (true) {
    const nextPos = move(position, direction);

    if (nextPos instanceof Error) {
      if (nextPos instanceof RangeError) {
        console.log(
          `Simulation complete. The guard will visit ${visited} squares.`,
        );
        break;
      } else if (nextPos instanceof ObstacleDetectedError) {
        console.log("Next position blocked. Turning right.");
        direction = newDirection(direction);
        console.log("Changing direction.");
      }
    } else {
      console.log(`Visited square with value ${nextPos.getValue(map)}`);
      if (nextPos.getValue(map) !== "X") {
        visited += 1;
      }

      position.setValue(map, "X");
      position = nextPos;
      position.setValue(map, getDirectionChar(direction));
    }

    // console.log("New map:");
    // // outputMap(map);
  }

  return visited;
}

let map = loadMap(inputMap);
const maxH = map.length;
const maxW = map[0].length;

console.log(solve(map));
